name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          echo "Version: $VERSION"

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Version must be in format v1.2.3"
            exit 1
          fi

          echo "✓ Version format is valid"

      - name: Run tests
        run: ./test/run-tests.sh

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${{ steps.version.outputs.version }}$" | head -1 || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.version.outputs.version }}"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG..${{ steps.version.outputs.version }}")
          else
            echo "No previous tag found, using all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${{ steps.version.outputs.version }})
          fi

          # Write to output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Usage

            To use this version in your workflows:

            ```yaml
            - name: Update Kamal accessories
              uses: robfrank/kamal-accessories-updater@${{ steps.version.outputs.version }}
              with:
                config-dir: config
                mode: update-all
            ```

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.previous_tag }}...${{ steps.version.outputs.version }}
          draft: false
          prerelease: false

  update-major-minor-tags:
    name: Update Major/Minor Tags
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          # Extract major and minor versions
          VERSION_NO_V="${VERSION#v}"
          MAJOR=$(echo "$VERSION_NO_V" | cut -d. -f1)
          MINOR=$(echo "$VERSION_NO_V" | cut -d. -f2)

          echo "major=v$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=v$MAJOR.$MINOR" >> $GITHUB_OUTPUT
          echo "full=$VERSION" >> $GITHUB_OUTPUT

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update major version tag
        run: |
          git tag -fa ${{ steps.version.outputs.major }} -m "Update ${{ steps.version.outputs.major }} tag to ${{ steps.version.outputs.full }}"
          git push origin ${{ steps.version.outputs.major }} --force

      - name: Update minor version tag
        run: |
          git tag -fa ${{ steps.version.outputs.minor }} -m "Update ${{ steps.version.outputs.minor }} tag to ${{ steps.version.outputs.full }}"
          git push origin ${{ steps.version.outputs.minor }} --force

      - name: Summary
        run: |
          echo "✓ Updated tags:"
          echo "  - ${{ steps.version.outputs.major }}"
          echo "  - ${{ steps.version.outputs.minor }}"
          echo "  - ${{ steps.version.outputs.full }}"
